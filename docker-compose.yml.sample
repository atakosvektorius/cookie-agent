services:
  cookie-agent:
    container_name: cookie-agent
    image: cookie-agent
    build: ./agent
    environment:
      API_KEY: "abcdef0123456789abcdef0123456789"
      GET_WORK_URL: "http://172.17.0.1/api/admin/cookies/getwork"
      PUSH_RESULTS_URL: "http://172.17.0.1/api/admin/cookies/push"
      HEALTHCHECK_FILE: "/tmp/healthcheck.log"
      LIMIT: 10
    shm_size: 2g
    labels:
      autoheal-cookie-agent: true
    dns:
      - 1.1.1.1
    tty: true
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/healthcheck.log && test $(($(date +%s) - $(stat -c %Y /tmp/healthcheck.log))) -lt 120"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  cookie-agent-deleted:
    container_name: cookie-agent-deleted
    image: cookie-agent
    build: ./agent
    environment:
      API_KEY: "abcdef0123456789abcdef0123456789"
      GET_WORK_URL: "http://172.17.0.1/api/admin/deletedcookies/getwork"
      PUSH_RESULTS_URL: "http://172.17.0.1/api/admin/cookies/push"
      HEALTHCHECK_FILE: "/tmp/healthcheck.log"
      LIMIT: 10
    shm_size: 2g
    dns:
      - 1.1.1.1
    tty: true
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/healthcheck.log && test $(($(date +%s) - $(stat -c %Y /tmp/healthcheck.log))) -lt 120"]
      interval: 60s
      timeout: 30s
      retries: 30
      start_period: 60s
    restart: unless-stopped


  cookie-agent-autoheal:
    container_name: cookie-agent-autoheal
    image: willfarrell/autoheal:1.2.0
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
    network_mode: none
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal-cookie-agent
    restart: unless-stopped
